<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‰µä½œåšå®¢</title>
    <!-- <link rel="stylesheet" href="style.css"> -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.bubble.css" rel="stylesheet">


    <style>
        /* åŸºæœ¬æ¨£å¼ */
        body {
            /* æŒ‡å®šå…ƒç´ çš„å­—é«”,é¦–é¸ä½¿ç”¨ Arial å­—é«”ï¼Œå¦‚æœè¨ˆç®—æ©Ÿä¸Šæ²’æœ‰å®‰è£ Arial å­—é«”ï¼Œå‰‡å‚™ç”¨ä½¿ç”¨ sans-serif å­—é«” */
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f0f0f0;
        }

        .toolbarPh {
            position: fixed;
            display: none;
            width: 100%;
            height: 38px;
            top: 0;
            z-index: 1;
        }

        nav {
            position: fixed;
            width: 100%;
            top: 0px;
            display: none;
            justify-content: space-around;
            background-color: #f0f0f0;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            z-index: 1;
        }

        nav ul {
            list-style: none;
            padding: 0;
        }

        nav ul li {
            display: inline;
            margin: 0 10px;
            cursor: pointer;
            position: relative;
        }

        nav ul li span {
            visibility: hidden;
            background-color: #ffffff;
            font-weight: normal;
            color: #3d3d3d;
            white-space: nowrap;
            border-radius: 6px;
            padding: 3px;
            position: absolute;
            bottom: -175%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.5s;
        }

        nav ul li:hover span {
            visibility: visible;
            opacity: 1;
        }

        #release {
            background-color: #007BFF;
            color: #fff;
            padding: 10px 20px;
            border-radius: 3px;
        }

        #release:hover {
            background-color: #0056b3;
        }

        main {
            max-width: 800px;
            margin: 20px auto 20px;
        }

        action {
            float: right;
            display: none;
        }

        action button {
            border: none;
        }

        article {
            background-color: #f0f0f0;
            padding: 1rem;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        }

        #title {
            margin: 20px 0px 5px 0px;
            padding-left: 0px;
            width: 100%;
            border: none;
            /*å»æ‰é¸ä¸­æ™‚çš„é‚Šæ¡†*/
            outline: none;
            font-size: 24px;
            font-weight: bold;
            background-color: #f0f0f0;
        }

        #title::placeholder {
            font-weight: normal;
        }

        #editor {
            outline: none;
            margin-top: 40px;
        }

        #editor .ql-editor {
            padding: 0;
            /* min-height: 200px; */
        }

        #editor p {
            font-size: 16px;
            line-height: 1.6;
        }
    </style>
</head>

<body>
    <div class="toolbarPh"></div>
    <nav>
        <ul>
            <li><strong id="bold">B</strong><span>åŠ ç²—</span></li>
            <li><em id="italic" style="font-family: Consolas; font-size: 19px;">I</em><span>æ–œé«”</span></li>
            <li><u id="underline">U</u><span>ä¸‹åŠƒç¶«</span></li>
            <li><s id="strike">S</s><span>åˆªé™¤ç¶«</span></li>
        </ul>
        <ul>
            <li id="release">ç™¼ä½ˆ</li>
        </ul>
    </nav>

    <main>
        <action><button id="edit">âœï¸</button><button id="delete">ğŸ—‘ï¸</button></action>
        <article>
            <input type="text" id="title" placeholder="è«‹åœ¨é€™è£è¼¸å…¥æ¨™é¡Œ,é•·åº¦ä¸è¶…é32" maxlength="32" required>
            <p id="release-date">ç™¼å¸ƒæ—¥æœŸï¼š2023-09-14</p>
            <p id="author">ä½œè€…ï¼šAidan</p>
            <div id="editor">
                <p>è«‹åœ¨é€™è£è¼¸å…¥å†…å®¹ã€‚ã€‚ã€‚</p>
            </div>
        </article>
    </main>

    <!-- <script src=" script.js"></script> -->
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script>
        // åˆ›å»ºå…¨å±€è®Šé‡quillå®ä¾‹
        const quill = new Quill('#editor', {
            theme: 'bubble',
            formats: ['bold', 'italic', 'underline', 'strike', 'image'],  // åªå…è®¸ç™½åå–®æ ¼å¼
            modules: {
                toolbar: ['bold', 'italic', 'underline', 'strike'],
            },
            clipboard: {
                // é»˜è®¤æƒ…å†µä¸‹ï¼ŒQuillæ˜¯ä¸ä¼šä¸ºæ¯ä¸€è¡Œæä¾›å¡«å……(padding)æˆ–è¾¹è·(margin)çš„ï¼Œä½†æ˜¯ä»å…¶ä»–ç½‘ç«™æˆ–æ¥æºç²˜è´´è¿‡æ¥çš„å¯èƒ½ä¼šå«æœ‰
                // é»˜è®¤æƒ…å†µä¸‹ï¼ŒQuillé€šè¿‡æ·»åŠ é¢å¤–è¡Œæ¥åŒ¹é…è¿™ä¸ªé—´è·ï¼Œä»¥å¼¥è¡¥ç¼ºå¤±çš„margin/paddingã€‚è¿™ä¸ªé€‰æ‹©é¡¹å°†ç¦ç”¨è¿™ä¸ªè¡Œä¸ºã€‚
                matchVisual: false,
            }
        });

        const urlParams = new URLSearchParams(window.location.search);
        const articleId = urlParams.get('id');  // ç²å–urlä¸­çš„åƒæ•¸
        if (articleId) {
            console.log("é€™è£æ˜¯æ–‡ç« è©³æƒ…, id=", articleId);
            setupDetailPage(); // è¨­ç½®è©³æƒ…é é¢
        } else {
            console.log("é€™è£æ˜¯å‰µå»ºæ–‡ç« ");
            setupCreationPage();  // è¨­ç½®å‰µå»ºé é¢
        }

        // =================è©³æƒ…é é¢å‡½æ•¸=================

        async function setupDetailPage() {
            const isLogin = await checkLoginStatus();  // æª¢æŸ¥æ˜¯å¦ç™»éŒ„
            const blog = await fetchArticle(isLogin);  // è«‹æ±‚ç¶²é æ•¸æ“š
            document.title = blog.title;  // è¨­ç½®ç¶²é æ¨™é¡Œ

            const actionElement = document.querySelector("action");  // æ˜¯ç•¶å‰ç”¨æˆ¶çš„æ–‡ç« å°±é¡¯ç¤ºç·¨è¼¯åˆªé™¤æŒ‰éˆ•
            actionElement.style.display = isLogin && (blog.authorId === localStorage.getItem('userId')) ? "block" : "none";

            const title = document.querySelector("#title")
            title.readOnly = true;  // è¨­ç½®æ¨™é¡Œåªè®€
            quill.enable(false);  // è¨­ç½®ç·¨è¼¯å™¨åªè®€

            // å¡«å……æ–‡ç« æ¨™é¡Œ, æ—¥æœŸ, ä½œè€…, å†…å®¹
            title.value = blog.title;
            document.querySelector("#release-date").textContent = `ç™¼å¸ƒæ—¥æœŸï¼š${blog.update_time.split('T')[0]}`;
            document.querySelector("#author").textContent = `ä½œè€…ï¼š${blog.author}`;
            quill.clipboard.dangerouslyPasteHTML(blog.content);

            document.getElementById("delete").addEventListener("click", handleDelete);  // é»æ“Šåˆªé™¤æŒ‰éˆ•åˆªé™¤æ–‡ç« 
            document.getElementById("edit").addEventListener("click", function () {  // é»æ“Šç·¨è¼¯æŒ‰éˆ•ç·¨è¼¯æ–‡ç« 
                actionElement.style.display = "none";
                setupCreationPage();  // è¨­ç½®å·¥å…·æ¬„è‡ªå‹•éš±è—å’Œå±•ç¤º
                quill.enable(!quill.isEnabled());
                title.readOnly = !title.readOnly;
                title.focus();
            });
        }

        async function handleDelete() {
            var confirmDelete = confirm("ç¢ºå®šè¦åˆªé™¤é€™ç¯‡æ–‡ç« å—ï¼Ÿ");
            if (confirmDelete) {  // åœ¨é€™è£¡è™•ç†åˆªé™¤æ“ä½œ
                if (await checkLoginStatus()) {
                    const response = await fetch('/api/blogs/blog/' + articleId, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${localStorage.getItem('access')}` },
                    });
                    if (response.status === 204) {  // æ¸²æŸ“é é¢
                        window.location.href = "index.html";  // è·³è½¬åˆ°å…¶ä»–é¡µé¢
                    } else {
                        const errorText = await response.text();
                        throw new Error(response.status + ' - ' + errorText);
                    }
                } else {
                    var confirmLogin = confirm("ç™»éŒ„å·²éæœŸ, è«‹é‡æ–°ç™»éŒ„!");
                    if (confirmLogin) {
                        window.open("login.html", "_blank");
                    }
                }
            }
        }

        async function fetchArticle(isLogin = false) {  // è«‹æ±‚ç¶²é æ•¸æ“š
            const headers = {};
            if (isLogin) {  // å¦‚æœå·²ç™»éŒ„å°±ä¸ä½¿ç”¨åŒ¿åèº«ä»½
                headers["Authorization"] = `Bearer ${localStorage.getItem('access')}`;
            }
            const response = await fetch('/api/blogs/blog/' + articleId, { headers: headers });
            if (response.status === 200) {
                const blog = await response.json();
                return blog;
            } else {
                const errorText = await response.text();
                throw new Error(response.status + ' - ' + errorText);
            }
        }

        // =================å‰µå»ºé é¢å‡½æ•¸=================

        function setupCreationPage() {
            setupToolbarBehavior();  // è¨­ç½®å·¥å…·æ¬„è‡ªå‹•éš±è—å’Œå±•ç¤º

            quill.clipboard.addMatcher(Node.ELEMENT_NODE, function (node, delta) {
                if (delta.ops.length > 0) {
                    delta.ops[0].attributes = {}; // å¦‚æœæ˜¯å…ƒç´ èŠ‚ç‚¹åˆ™æ¸…ç©ºæ ·å¼
                }
                return delta;
            });
            quill.clipboard.addMatcher("img", function (node, delta) {
                url = delta.ops[0].insert.image
                console.log(url);  // å¦‚æœæ˜¯å›¾ç‰‡èŠ‚ç‚¹, åœ¨é€™è£å¯¦ç¾åœ–ç‰‡çš„è™•ç†é‚è¼¯, ä¾‹å¦‚ä¸Šå‚³æœå‹™å™¨ç­‰
                return delta;
            });
            quill.root.addEventListener('paste', pasteImage);  // ç‚ºquillç·¨è¼¯å™¨è‡ªå·±ç·¨å¯«ç²˜è´´å›¾ç‰‡çš„åŠŸèƒ½
        }

        function setupToolbarBehavior() {  // å·¥å…·æ¬„è‡ªå‹•æ ¹æ“šé¼ æ¨™ ä½ç½®åœ¨é ‚éƒ¨æ™‚éš±è—å’Œå±•ç¤º
            const toolbar = document.querySelector("nav");
            const toolbarPh = document.querySelector(".toolbarPh");

            toolbarPh.style.display = "block";
            toolbarPh.addEventListener("mouseenter", () => toolbar.style.display = "flex");  // é¼ æ¨™é€²å…¥é¡¯ç¤ºå·¥å…·æ¬„
            toolbar.addEventListener("mouseleave", () => toolbar.style.display = "none");  // é¼ æ¨™é›¢é–‹éš±è—å·¥å…·æ¬„

            // é˜»æ­¢é¼ æ¨™é»æ“Šå·¥å…·æ¬„å°è‡´ç·¨è¼¯å™¨å¤±å»ç„¦é», å¿…é ˆä½¿ç”¨mousedownäº‹ä»¶ï¼Œè‹¥ç”¨clickäº‹ä»¶ï¼Œå‰‡ä¸èµ·ä½œç”¨
            toolbar.addEventListener("mousedown", event => event.preventDefault());
            // ä½¿ç”¨äº‹ä»¶å§”æ‰˜ç‚ºå·¥å…·æ¬„æŒ‰éˆ•æ·»åŠ åŠŸèƒ½, æ‰“é–‹æˆ–é—œé–‰ç‰¹å®šæ ¼å¼ã€‚
            toolbar.addEventListener("click", (e) => quill.format(e.target.id, !quill.getFormat()[e.target.id]));
            document.querySelector("#release").addEventListener("click", handleRelease);  // é»æ“Šç™¼ä½ˆæŒ‰éˆ•ç™¼ä½ˆæ–‡ç« 
        }

        async function handleRelease() {
            var method = 'POST';
            var url = '/api/blogs/blog/'
            if (articleId) {
                method = 'PATCH';
                url = url + articleId + '/';
            }
            const title = document.getElementById("title").value;
            const content = quill.root.innerHTML;
            if (await checkLoginStatus()) {
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${localStorage.getItem('access')}` },
                    body: JSON.stringify({ "title": title, "content": content })
                });
                if (response.ok === true) {
                    const data = await response.json();
                    window.location.href = 'article.html?id=' + data.id;  // é‡å®šå‘åˆ°å…¶ä»–é¡µé¢
                } else {
                    const errorText = await response.text();
                    throw new Error(response.status + ' - ' + errorText);
                }
            } else {
                var confirmLogin = confirm("ç™»éŒ„å·²éæœŸ, è«‹é‡æ–°ç™»éŒ„!");
                if (confirmLogin) {
                    window.open("login.html", "_blank");
                }
            }
        }

        async function pasteImage(e) {
            var clipboardData = e.clipboardData || window.clipboardData;  // è·å–ç²˜è´´æ¿çš„å†…å®¹
            var imageArray = [];
            for (const item of clipboardData.items) {
                if (item.type.indexOf('image') !== -1) {
                    const blob = item.getAsFile();  // æå–å›¾åƒæ•°æ®
                    imageArray.push(blob);
                }
            }
            if (imageArray.length > 0) {
                e.preventDefault();  // é˜»æ­¢é»˜è®¤çš„ç²˜è´´è¡Œä¸º
                if (await checkLoginStatus()) {
                    for (const blob of imageArray) {
                        const data = await uploadImage(blob);
                        quill.insertEmbed(quill.getSelection(focus = true).index, 'image', '/media/' + data.image);
                        quill.setSelection(quill.getSelection(focus = true).index + 1);
                    }
                } else {
                    var confirmLogin = confirm("ç™»éŒ„å·²éæœŸ, è«‹é‡æ–°ç™»éŒ„!");
                    if (confirmLogin) {
                        window.open("login.html", "_blank");
                    }
                }
            }
        }

        async function uploadImage(imageFile) {
            const formData = new FormData();
            formData.append('image', imageFile);

            const response = await fetch('/api/blogs/image/upload/', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${localStorage.getItem('access')}` },
                body: formData
            });
            if (response.status === 201) {
                return await response.json();
            } else {
                const errorText = await response.text();
                throw new Error(response.status + ' - ' + errorText);
            }
        }

        async function checkLoginStatus() {  // æª¢æŸ¥æ˜¯å¦ç™»éŒ„
            const access = localStorage.getItem('access');
            const refresh = localStorage.getItem('refresh');
            if (access) {
                const response_access = await fetch('/api/users/token/verify/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ "token": access })
                });
                if (response_access.status === 200) {
                    return true;
                } else if (response_access.status === 401 && refresh) {  // å¦‚æœè¨ªå•ä»¤ç‰ŒéæœŸ, å˜—è©¦åˆ·æ–°ä»¤ç‰Œ
                    const response_refresh = await fetch('/api/users/token/verify/', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ "token": refresh })
                    });
                    if (response_refresh.status === 200) {
                        const response_refresh_access = await fetch('/api/users/token/refresh/', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ "refresh": refresh })
                        });
                        if (response_refresh_access.status === 200) {
                            const data = await response_refresh_access.json();
                            localStorage.setItem('access', data.access);  // å­˜å‚¨è®¿é—®ä»¤ç‰Œåˆ°æœ¬åœ°å­˜å‚¨
                            return true;
                        } else { return false; }
                    } else { return false; }
                } else { return false; }
            } else { return false; }
        }
    </script>
</body>

</html>